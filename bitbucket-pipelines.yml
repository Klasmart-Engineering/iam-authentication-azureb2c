image: node:16

definitions:
    caches:
        cypress: $HOME/.cache/Cypress
    steps:
        - step: &deps
              name: Install npm dependencies
              caches:
                  - node
              script:
                  - npm install
        - step: &checks
              name: Check JS/CSS
              caches:
                  - node
              script:
                  - npm run check
        - step: &build-assets
              name: Build HTML/JS/CSS/images
              caches:
                  - node
              script:
                  - export $(cat .env | xargs)
                  - npm run build -- --env=environment=$ENVIRONMENT
              artifacts:
                  - dist/**
        - step: &build-policies
              name: Build B2C policy XML
              image: mcr.microsoft.com/powershell
              script:
                  - pwsh -Command "scripts/Build-CustomPolicies.ps1 -FilePath src/policies/custom_policies"
              artifacts:
                  - src/policies/custom_policies/**
        - step: &deploy
              name: Deploy assets/policies to B2C
              script:
                  - export $(cat .env | xargs)
                  - pipe: atlassian/azure-storage-deploy:1.0.2
                    variables:
                        SOURCE: "dist/**"
                        DESTINATION: "https://$STORAGE_ACCOUNT.blob.core.windows.net/$STORAGE_CONTAINER?"
                        DESTINATION_SAS_TOKEN: $AzureStorageSasToken
                        EXTRA_ARGS: "--recursive --overwrite=true"
                        DEBUG: "true"
                  - npx ieftool deploy -t $TENANT_ID -c $CLIENT_ID -s $SECRET -p src/policies/custom_policies/Environments/$ENVIRONMENT
        - step: &e2e-tests
              name: "UI Cypress Regression Tests - Chrome Browser"
              image: cypress/browsers:node16.5.0-chrome97-ff96
              script:
                  - git clone git@bitbucket.org:calmisland/kidsloop-auth-frontend.git --branch dev
                  - cd kidsloop-auth-frontend
                  - npm i --no-audit --no-progress
                  - npm run $CYPRESS_TEST_CMD
                  - npm run e2e:reports
              caches:
                  - node
                  - cypress
              artifacts:
                  # store any generates images and videos as artifacts
                  - cypress/screenshots/**
                  - cypress/cucumber-json
                  - cypress/videos/**
                  - test-reports/**
                  - test-reports/cucumber-report/cucumber-htmlreport/index.html

pipelines:
    default:
        - step: *deps
        - step: *checks
        - step:
              name: Setup environment
              script:
                  - echo 'ENVIRONMENT="SSO"' >> .env
              artifacts:
                  - .env
        - parallel:
              - step: *build-assets
              - step: *build-policies

    branches:
        master:
            - step: *deps
            - step: *checks
            - step:
                  name: Setup environment
                  script:
                      - echo 'ENVIRONMENT="SSO"' >> .env
                  artifacts:
                      - .env
            - parallel:
                  - step: *build-assets
                  - step: *build-policies
            - step:
                  <<: *deploy
                  deployment: SSO
            - step: *e2e-tests
    custom:
        deploy-loadtest:
            - step: *deps
            - step: *checks
            - step:
                  name: Setup environment
                  script:
                      - echo 'ENVIRONMENT="LOADTEST"' >> .env
                  artifacts:
                      - .env
            - parallel:
                  - step: *build-assets
                  - step: *build-policies
            - step:
                  <<: *deploy
                  deployment: LOADTEST
        deploy-alpha-dev:
            - step: *deps
            - step: *checks
            - step:
                  name: Setup environment
                  script:
                      - echo 'ENVIRONMENT="Alpha-Dev"' >> .env
                  artifacts:
                      - .env
            - parallel:
                  - step: *build-assets
                  - step: *build-policies
            - step:
                  <<: *deploy
                  deployment: Alpha-Dev
